name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write  # Required for npm trusted publishers (OIDC)

jobs:
  # Job 1: Publish to npm using trusted publishers (OIDC)
  npm-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install latest npm (>=11.5.1 required for OIDC)
        run: npm install -g npm@latest && npm --version

      - run: npm ci
      - run: npm run build
      - run: npm publish --provenance --access public

  # Job 2a: Build macOS binaries (with native code signing)
  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: oven-sh/setup-bun@v2

      - run: npm ci

      - name: Build macOS binaries
        run: |
          bun build src/index.tsx --compile --target=bun-darwin-arm64 --outfile dpr-macos-arm64
          bun build src/index.tsx --compile --target=bun-darwin-x64 --outfile dpr-macos-x64

      - name: Sign macOS binaries
        run: |
          codesign --sign - --force dpr-macos-arm64
          codesign --sign - --force dpr-macos-x64

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: |
            dpr-macos-arm64
            dpr-macos-x64

  # Job 2b: Build Linux and Windows binaries
  build-linux-windows:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: oven-sh/setup-bun@v2

      - run: npm ci

      - name: Build Linux and Windows binaries
        run: |
          bun build src/index.tsx --compile --target=bun-linux-x64 --outfile dpr-linux-x64
          bun build src/index.tsx --compile --target=bun-linux-arm64 --outfile dpr-linux-arm64
          bun build src/index.tsx --compile --target=bun-windows-x64 --outfile dpr-win-x64.exe

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-windows
          path: |
            dpr-linux-x64
            dpr-linux-arm64
            dpr-win-x64.exe

  # Job 3: Create GitHub Release
  create-release:
    needs: [build-macos, build-linux-windows]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true

  # Job 4: Update Homebrew formula
  update-homebrew:
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: tx2z/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download release artifacts
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Downloading release artifacts for v${VERSION}..."

          curl -L -o dpr-macos-arm64 "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-macos-arm64"
          curl -L -o dpr-macos-x64 "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-macos-x64"
          curl -L -o dpr-linux-arm64 "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-linux-arm64"
          curl -L -o dpr-linux-x64 "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-linux-x64"

      - name: Calculate SHA256 and update formula
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          SHA_MACOS_ARM64=$(sha256sum dpr-macos-arm64 | cut -d' ' -f1)
          SHA_MACOS_X64=$(sha256sum dpr-macos-x64 | cut -d' ' -f1)
          SHA_LINUX_ARM64=$(sha256sum dpr-linux-arm64 | cut -d' ' -f1)
          SHA_LINUX_X64=$(sha256sum dpr-linux-x64 | cut -d' ' -f1)

          echo "SHA256 checksums:"
          echo "  macOS ARM64: ${SHA_MACOS_ARM64}"
          echo "  macOS x64:   ${SHA_MACOS_X64}"
          echo "  Linux ARM64: ${SHA_LINUX_ARM64}"
          echo "  Linux x64:   ${SHA_LINUX_X64}"

          mkdir -p homebrew-tap/Formula

          cat > homebrew-tap/Formula/dev-process-runner.rb << 'FORMULA'
          class DevProcessRunner < Formula
            desc "Terminal UI for managing multiple development services"
            homepage "https://github.com/tx2z/dpr"
            license "MIT"
          FORMULA

          cat >> homebrew-tap/Formula/dev-process-runner.rb << FORMULA
            version "${VERSION}"

            on_macos do
              on_arm do
                url "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-macos-arm64"
                sha256 "${SHA_MACOS_ARM64}"
              end
              on_intel do
                url "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-macos-x64"
                sha256 "${SHA_MACOS_X64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-linux-arm64"
                sha256 "${SHA_LINUX_ARM64}"
              end
              on_intel do
                url "https://github.com/tx2z/dpr/releases/download/v${VERSION}/dpr-linux-x64"
                sha256 "${SHA_LINUX_X64}"
              end
            end
          FORMULA

          cat >> homebrew-tap/Formula/dev-process-runner.rb << 'FORMULA'

            def install
              binary_name = if OS.mac?
                Hardware::CPU.arm? ? "dpr-macos-arm64" : "dpr-macos-x64"
              else
                Hardware::CPU.arm? ? "dpr-linux-arm64" : "dpr-linux-x64"
              end
              bin.install binary_name => "dpr"
            end

            test do
              assert_match "dpr", shell_output("#{bin}/dpr --help 2>&1", 1)
            end
          end
          FORMULA

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/dev-process-runner.rb
          git diff --staged --quiet || git commit -m "Update dpr to ${GITHUB_REF#refs/tags/}"
          git push
